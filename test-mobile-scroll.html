<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Mobile Scroll Test - Hello Chatbot</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: #f5f5f5;
            padding: 20px;
        }

        .test-container {
            max-width: 420px;
            margin: 0 auto;
            background: white;
            border-radius: 12px;
            padding: 20px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }

        h1 {
            font-size: 24px;
            margin-bottom: 10px;
            color: #2563eb;
        }

        .intro {
            margin-bottom: 20px;
            padding: 15px;
            background: #f0f9ff;
            border-left: 4px solid #2563eb;
            border-radius: 4px;
        }

        .intro h2 {
            font-size: 16px;
            margin-bottom: 8px;
            color: #1d4ed8;
        }

        .intro p {
            font-size: 14px;
            line-height: 1.6;
            color: #334155;
            margin-bottom: 8px;
        }

        .intro ul {
            font-size: 14px;
            line-height: 1.6;
            color: #334155;
            margin-left: 20px;
        }

        .intro li {
            margin-bottom: 4px;
        }

        .test-section {
            margin-bottom: 30px;
        }

        .test-section h2 {
            font-size: 18px;
            margin-bottom: 15px;
            color: #1e293b;
        }

        .messages-demo {
            height: 400px;
            border: 2px solid #e2e8f0;
            border-radius: 8px;
            overflow-y: auto;
            padding: 15px;
            display: flex;
            flex-direction: column;
            gap: 12px;
            background: #fafafa;
            -webkit-overflow-scrolling: touch;
            overscroll-behavior: contain;
            touch-action: pan-y;
        }

        .message {
            padding: 12px 16px;
            border-radius: 12px;
            max-width: 85%;
            animation: fadeIn 0.3s ease;
        }

        @keyframes fadeIn {
            from {
                opacity: 0;
                transform: translateY(10px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .message.user {
            background: #F1F2F4;
            color: #2A2B2C;
            align-self: flex-end;
            margin-left: auto;
        }

        .message.assistant {
            background: white;
            color: #2A2B2C;
            align-self: flex-start;
            border: 1px solid #e2e8f0;
        }

        .message.streaming {
            position: relative;
        }

        .message.streaming::after {
            content: '‚ñã';
            animation: blink 1s infinite;
            margin-left: 2px;
        }

        @keyframes blink {
            0%, 50% { opacity: 1; }
            51%, 100% { opacity: 0; }
        }

        .controls {
            display: flex;
            gap: 10px;
            margin-top: 15px;
            flex-wrap: wrap;
        }

        button {
            padding: 10px 16px;
            border: none;
            border-radius: 8px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
        }

        .btn-primary {
            background: #2563eb;
            color: white;
        }

        .btn-primary:hover {
            background: #1d4ed8;
        }

        .btn-secondary {
            background: #64748b;
            color: white;
        }

        .btn-secondary:hover {
            background: #475569;
        }

        .btn-danger {
            background: #ef4444;
            color: white;
        }

        .btn-danger:hover {
            background: #dc2626;
        }

        .status {
            margin-top: 15px;
            padding: 12px;
            background: #f8fafc;
            border-radius: 8px;
            font-size: 13px;
            color: #475569;
        }

        .status strong {
            color: #1e293b;
        }

        .success {
            background: #f0fdf4;
            color: #166534;
            padding: 12px;
            border-radius: 8px;
            margin-top: 10px;
        }

        .info {
            background: #eff6ff;
            color: #1e40af;
            padding: 12px;
            border-radius: 8px;
            margin-top: 10px;
            font-size: 13px;
            line-height: 1.5;
        }

        @media (max-width: 480px) {
            body {
                padding: 10px;
            }

            .test-container {
                padding: 15px;
            }

            h1 {
                font-size: 20px;
            }

            .messages-demo {
                height: 60vh;
            }
        }
    </style>
</head>
<body>
    <div class="test-container">
        <h1>üß™ Mobile Scroll Test</h1>

        <div class="intro">
            <h2>Testing Fix for Mobile Scroll Issue</h2>
            <p><strong>Problem:</strong> On mobile, users couldn't scroll in the chat window after the response finished streaming.</p>
            <p><strong>Root Causes:</strong></p>
            <ul>
                <li>CSS <code>contain</code> property interfered with scroll</li>
                <li>Aggressive auto-scroll every 50ms during streaming</li>
                <li>No detection of user manual scrolling</li>
            </ul>
            <p><strong>Solution:</strong></p>
            <ul>
                <li>Removed CSS <code>contain</code> property</li>
                <li>Added <code>touch-action: pan-y</code> for mobile</li>
                <li>Smart auto-scroll: only scrolls if user is at bottom</li>
                <li>Detects manual scroll during streaming</li>
            </ul>
        </div>

        <div class="test-section">
            <h2>Test Area</h2>

            <div id="messages" class="messages-demo">
                <div class="message assistant">
                    Welcome to the scroll test! Try the following:
                    <br><br>
                    1. Click "Simulate Streaming Response"<br>
                    2. While it's streaming, try scrolling up<br>
                    3. Notice the auto-scroll stops when you scroll up<br>
                    4. Scroll back to bottom during streaming<br>
                    5. Auto-scroll resumes!<br>
                    6. After streaming completes, verify you can scroll freely
                </div>
            </div>

            <div class="controls">
                <button class="btn-primary" onclick="simulateStreaming()">
                    Simulate Streaming Response
                </button>
                <button class="btn-secondary" onclick="addUserMessage()">
                    Add User Message
                </button>
                <button class="btn-danger" onclick="clearMessages()">
                    Clear All
                </button>
            </div>

            <div id="status" class="status">
                <strong>Status:</strong> Ready to test
            </div>

            <div class="info">
                <strong>‚úÖ Expected Behavior:</strong><br>
                ‚Ä¢ During streaming, scroll automatically follows new content IF you're at the bottom<br>
                ‚Ä¢ If you scroll up during streaming, auto-scroll stops (you can read older messages)<br>
                ‚Ä¢ If you scroll back to bottom during streaming, auto-scroll resumes<br>
                ‚Ä¢ After streaming completes, you can scroll freely without any restrictions
            </div>
        </div>
    </div>

    <script>
        let isStreaming = false;
        let userHasScrolledUp = false;
        let messageCounter = 0;

        const messagesContainer = document.getElementById('messages');
        const statusDiv = document.getElementById('status');

        // Detect manual scrolling
        messagesContainer.addEventListener('scroll', () => {
            if (isStreaming) {
                userHasScrolledUp = !isScrolledToBottom();
                updateStatus();
            }
        });

        function isScrolledToBottom() {
            const threshold = 100;
            const position = messagesContainer.scrollTop + messagesContainer.clientHeight;
            const height = messagesContainer.scrollHeight;
            return position >= height - threshold;
        }

        function scrollToBottom(force = false) {
            if (isStreaming && !force) {
                if (isScrolledToBottom()) {
                    messagesContainer.scrollTop = messagesContainer.scrollHeight;
                }
            } else {
                messagesContainer.scrollTop = messagesContainer.scrollHeight;
            }
        }

        function updateStatus() {
            const scrollPos = Math.round(messagesContainer.scrollTop);
            const scrollHeight = messagesContainer.scrollHeight;
            const clientHeight = messagesContainer.clientHeight;
            const atBottom = isScrolledToBottom();

            if (isStreaming) {
                statusDiv.innerHTML = `
                    <strong>Status:</strong> Streaming in progress<br>
                    <strong>Scroll Position:</strong> ${scrollPos}px / ${scrollHeight - clientHeight}px<br>
                    <strong>At Bottom:</strong> ${atBottom ? '‚úÖ Yes' : '‚ùå No'}<br>
                    <strong>Auto-Scroll Active:</strong> ${atBottom ? '‚úÖ Yes' : '‚ùå No (user scrolled up)'}
                `;
            } else {
                statusDiv.innerHTML = `
                    <strong>Status:</strong> Ready to test<br>
                    <strong>Scroll Position:</strong> ${scrollPos}px / ${scrollHeight - clientHeight}px<br>
                    <strong>At Bottom:</strong> ${atBottom ? '‚úÖ Yes' : '‚ùå No'}
                `;
            }
        }

        async function simulateStreaming() {
            if (isStreaming) return;

            // Add user message
            addMessage('user', 'Tell me a long story about chatbots');

            // Create assistant message
            const messageEl = document.createElement('div');
            messageEl.className = 'message assistant streaming';
            messagesContainer.appendChild(messageEl);

            isStreaming = true;
            userHasScrolledUp = false;
            updateStatus();

            const longResponse = `In the digital realm of modern technology, chatbots have revolutionized how we interact with computers.
            These intelligent assistants use natural language processing to understand and respond to human queries.
            From simple rule-based systems to advanced AI models, chatbots have evolved tremendously over the years.
            They now power customer service, e-commerce, healthcare, and education platforms worldwide.
            The key to a great chatbot experience is seamless interaction and responsive design.
            Mobile optimization is crucial, as most users access chatbots on their smartphones.
            Scroll behavior must be intuitive and never prevent users from reviewing previous messages.
            Smart auto-scrolling enhances usability by keeping new content visible without being intrusive.
            When a user manually scrolls up to read earlier messages, the system should respect that action.
            Only when the user scrolls back to the bottom should auto-scrolling resume during streaming.
            This creates a natural, user-friendly experience that feels responsive and thoughtful.
            The future of chatbots includes even more sophisticated context awareness and personalization.
            As technology advances, these digital assistants will become even more helpful and intuitive.`;

            const words = longResponse.split(' ');
            let accumulatedText = '';

            for (let i = 0; i < words.length; i++) {
                accumulatedText += (i > 0 ? ' ' : '') + words[i];
                messageEl.textContent = accumulatedText;

                scrollToBottom();
                updateStatus();

                await new Promise(resolve => setTimeout(resolve, 100));
            }

            messageEl.classList.remove('streaming');
            isStreaming = false;
            userHasScrolledUp = false;

            statusDiv.innerHTML += '<div class="success">‚úÖ Streaming completed! You should now be able to scroll freely.</div>';
            updateStatus();
        }

        function addUserMessage() {
            addMessage('user', `Test message ${++messageCounter}`);
            scrollToBottom(true);
            updateStatus();
        }

        function addMessage(role, text) {
            const messageEl = document.createElement('div');
            messageEl.className = `message ${role}`;
            messageEl.textContent = text;
            messagesContainer.appendChild(messageEl);
            scrollToBottom(true);
        }

        function clearMessages() {
            messagesContainer.innerHTML = `
                <div class="message assistant">
                    All messages cleared! Add some messages to test scrolling behavior.
                </div>
            `;
            messageCounter = 0;
            isStreaming = false;
            userHasScrolledUp = false;
            updateStatus();
        }

        // Initialize
        updateStatus();
    </script>
</body>
</html>
